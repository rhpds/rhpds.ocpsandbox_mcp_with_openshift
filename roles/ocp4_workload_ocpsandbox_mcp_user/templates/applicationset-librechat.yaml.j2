---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: "{{ _ocpsandbox_mcp_user }}-librechat"
  namespace: openshift-gitops
spec:
  syncPolicy:
    preserveResourcesOnDeletion: false
  generators:
  - list:
      elements:
      - user: {{ _ocpsandbox_mcp_user }}
  template:
    metadata:
      name: "librechat-{% raw %}{{ user }}{% endraw %}"
      namespace: openshift-gitops
      finalizers:
      - resources-finalizer.argocd.argoproj.io
    spec:
      destination:
        name: ""
        namespace: "{{ ocp4_workload_ocpsandbox_mcp_user_librechat_namespace }}"
        server: https://kubernetes.default.svc
      project: {{ ocp4_workload_ocpsandbox_mcp_user_argocd_project }}
      syncPolicy:
        syncOptions:
        - CreateNamespace=false
        automated:
          prune: true
          selfHeal: false
      source:
        repoURL: {{ ocp4_workload_ocpsandbox_mcp_user_librechat_repo }}
        path: {{ ocp4_workload_ocpsandbox_mcp_user_librechat_repo_path }}
        targetRevision: {{ ocp4_workload_ocpsandbox_mcp_user_librechat_repo_tag }}
        helm:
          values: |
            fullnameOverride: librechat

            # OpenShift compatibility - OpenShift assigns UIDs automatically
            podSecurityContext:
              fsGroup: null

            securityContext:
              capabilities:
                drop:
                - ALL
              runAsNonRoot: false
              runAsUser: null

            # Environment variables for LibreChat
            librechat:
              configYamlContent: |-
                version: 1.3.1
                cache: true

                # Remote MCP Server Configuration
                mcpServers:
                  openshift:
                    type: sse
                    url: "http://mcp-openshift-proxy.{{ ocp4_workload_ocpsandbox_mcp_user_openshift_namespace }}.svc.cluster.local:8080/sse#openshift"
                  gitea:
                    type: streamable-http
                    url: "http://mcp-gitea-proxy.{{ ocp4_workload_ocpsandbox_mcp_user_mcp_gitea_namespace }}.svc.cluster.local:8080/mcp"
                  fetch:
                    type: streamable-http
                    url: "http://mcp-fetch-proxy.{{ ocp4_workload_ocpsandbox_mcp_user_mcp_gitea_namespace }}.svc.cluster.local:8080/mcp"
                  yardstick:
                    type: streamable-http
                    url: "http://mcp-yardstick-proxy.{{ ocp4_workload_ocpsandbox_mcp_user_mcp_gitea_namespace }}.svc.cluster.local:8080/mcp"

                # Custom OpenAI-compatible endpoints
                endpoints:
                  custom:
                  - name: "LiteMaaS"
                    apiKey: "${CUSTOM_MODEL_KEY}"
                    baseURL: {{ ocp4_workload_ocpsandbox_mcp_user_litemaas_url }}
                    models:
                      default: {{ ocp4_workload_ocpsandbox_mcp_user_litemaas_models }}
                      fetch: true
                    titleConvo: false
                    summarize: false
                    forcePrompt: false
                    modelDisplayLabel: "Demo Dot LiteMaaS"
                    capabilities:
                    - "tools"
                    dropParams:
                    - "user"
                    - "frequency_penalty"
                    - "presence_penalty"

              configEnv:
                ALLOW_REGISTRATION: "true"
                ALLOW_EMAIL_LOGIN: "true"

            # Don't configure ingress, create a route for OpenShift outside of the helm chart
            ingress:
              enabled: false

            # Resource requests/limits required by namespace quota
            # (sandbox API limit_range shorthand doesn't populate LimitRange defaults)
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: "1"
                memory: 2Gi

            # Add writable volumes for logs
            volumes:
            - name: logs
              emptyDir: {}
            - name: logs-root
              emptyDir: {}

            volumeMounts:
            - name: logs
              mountPath: /app/api/logs
            - name: logs-root
              mountPath: /app/logs

            # Global OpenShift compatibility for MongoDB
            global:
              compatibility:
                openshift:
                  adaptSecurityContext: force

            # MongoDB configuration
            mongodb:
              image:
                tag: "latest"
              global:
                compatibility:
                  openshift:
                    adaptSecurityContext: force

            # Meilisearch configuration
            meilisearch:
              image:
                repository: docker.io/getmeili/meilisearch
                tag: v1.7.3
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: "1"
                  memory: 1Gi
              podSecurityContext:
                runAsNonRoot: false
                runAsUser: null
                runAsGroup: null
                fsGroup: null
                fsGroupChangePolicy: null
              securityContext: {}
