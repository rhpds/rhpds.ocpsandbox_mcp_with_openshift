---
- name: Set user variable shorthand
  ansible.builtin.set_fact:
    _ocpsandbox_mcp_user: "{{ ocp4_workload_ocpsandbox_mcp_user_username }}"

# ------------------------------------------------------------------
# Discover cluster ingress domain (may not be set if keycloak_user
# role has not run yet during destroy)
# ------------------------------------------------------------------
- name: Discover cluster ingress domain
  when: openshift_cluster_ingress_domain is not defined
  block:
  - name: Get cluster ingress config
    kubernetes.core.k8s_info:
      host: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_url }}"
      api_key: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_token }}"
      validate_certs: false
      api_version: config.openshift.io/v1
      kind: Ingress
      name: cluster
    register: r_ingress_config

  - name: Set ingress domain fact
    ansible.builtin.set_fact:
      openshift_cluster_ingress_domain: >-
        {{ r_ingress_config.resources[0].spec.domain }}

# ------------------------------------------------------------------
# Delete ApplicationSets (cascades to Applications and namespaces)
# ------------------------------------------------------------------
- name: Delete ApplicationSets
  kubernetes.core.k8s:
    host: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_url }}"
    api_key: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_token }}"
    validate_certs: false
    api_version: argoproj.io/v1alpha1
    kind: ApplicationSet
    name: "{{ item }}"
    namespace: openshift-gitops
    state: absent
  loop:
  - agent
  - librechat
  - librechat-config
  - mcp-gitea
  - mcp-openshift

# ------------------------------------------------------------------
# Wait for ArgoCD Applications to be removed
# ------------------------------------------------------------------
- name: Set expected Application names
  ansible.builtin.set_fact:
    _ocpsandbox_mcp_expected_apps:
    - "agent-{{ _ocpsandbox_mcp_user }}"
    - "{{ ocp4_workload_ocpsandbox_mcp_user_librechat_namespace_base }}-{{ _ocpsandbox_mcp_user }}"
    - "librechat-config-{{ _ocpsandbox_mcp_user }}"
    - "mcp-gitea-{{ _ocpsandbox_mcp_user }}"
    - "mcp-openshift-{{ _ocpsandbox_mcp_user }}"

- name: Wait for Applications to be deleted
  kubernetes.core.k8s_info:
    host: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_url }}"
    api_key: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_token }}"
    validate_certs: false
    api_version: argoproj.io/v1alpha1
    kind: Application
    namespace: openshift-gitops
  register: r_apps
  until: >-
    r_apps.resources
    | map(attribute='metadata.name')
    | intersect(_ocpsandbox_mcp_expected_apps)
    | length == 0
  retries: 30
  delay: 10

# ------------------------------------------------------------------
# Clean up namespaces (in case ArgoCD didn't remove them)
# ------------------------------------------------------------------
- name: Delete user namespaces
  kubernetes.core.k8s:
    host: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_url }}"
    api_key: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_token }}"
    validate_certs: false
    api_version: v1
    kind: Namespace
    name: "{{ item }}"
    state: absent
  loop:
  - "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_namespace_base }}-{{ _ocpsandbox_mcp_user }}"
  - "{{ ocp4_workload_ocpsandbox_mcp_user_gitea_namespace_base }}-{{ _ocpsandbox_mcp_user }}"
  - "{{ ocp4_workload_ocpsandbox_mcp_user_librechat_namespace_base }}-{{ _ocpsandbox_mcp_user }}"
  - "{{ ocp4_workload_ocpsandbox_mcp_user_agent_namespace_base }}-{{ _ocpsandbox_mcp_user }}"
  - "{{ ocp4_workload_ocpsandbox_mcp_user_gitea_namespace }}"
  ignore_errors: true

# ------------------------------------------------------------------
# Delete SCC
# ------------------------------------------------------------------
- name: Delete SCC
  kubernetes.core.k8s:
    host: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_url }}"
    api_key: "{{ ocp4_workload_ocpsandbox_mcp_user_openshift_api_token }}"
    validate_certs: false
    api_version: security.openshift.io/v1
    kind: SecurityContextConstraints
    name: mcpserver-scc
    state: absent
  ignore_errors: true
